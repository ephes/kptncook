beads_dir = ".beads"
beads_no_db = false
interval_seconds = 30
log_level = "info"
implementer = "codex"
reviewer = "claude"

# Run beadsflow from the local checkout in ../beadsflow, not the package:
# uv run --project ../beadsflow beadsflow run <epic-id> --dry-run --verbose

[implementers.codex]
comment_mode = "stdout"
comment_prefix = "Ready for review:\n\n"
comment_suffix = "\n\nValidation:\n- (run by reviewer)\n"
require_git_changes = false
command = """bash -lc 'set -euo pipefail
export BEADS_NO_DAEMON=1
export BEADS_DIR="$PWD/.beads"
export BD_ISSUE_PREFIX="${BD_ISSUE_PREFIX:-kptncook}"
issue="$BEADSFLOW_ISSUE_ID"
epic="$BEADSFLOW_EPIC_ID"

export BEADSFLOW_MAX_COMMENT_BYTES="${BEADSFLOW_MAX_COMMENT_BYTES:-800}"
export BEADSFLOW_MAX_COMMENT_LINES="${BEADSFLOW_MAX_COMMENT_LINES:-40}"

cap_comment() {
  # With `set -o pipefail`, truncation can cause SIGPIPE upstream; never fail the script.
  sed -n "1,${BEADSFLOW_MAX_COMMENT_LINES}p" | head -c "${BEADSFLOW_MAX_COMMENT_BYTES}" || true
}

msgfile="$(mktemp -t beadsflow-codex-msg.XXXXXX)"
cleanup() { rm -f "$msgfile"; }
trap cleanup EXIT

set +e
# Redirect codex stdout to stderr so beadsflow only posts the curated summary below.
codex --ask-for-approval never exec --sandbox workspace-write --output-last-message "$msgfile" \
  "Implement bead ${issue} under epic ${epic}. First, read the bead and its dependency chain using JSONL mode: bd --no-daemon --no-db show ${issue}; bd --no-daemon --no-db dep tree ${issue}. If the bead references a spec/PRD, read it before changing code. Implement the acceptance criteria by editing files in this repo. Ensure there is a non-empty git diff when done. Do not post Beads comments yourself. Do not run tests, type checks, lint/format, or install commands; the reviewer handles validation. Keep your final summary concise (<= ~8 bullets)." 1>&2
codex_rc=$?
set -e

if [ -s "$msgfile" ]; then
  cat "$msgfile" | cap_comment || true
else
  printf "%s\n" "(no summary captured from codex)" | cap_comment || true
fi

if [ "${codex_rc}" != "0" ]; then
  printf "\n\nNote: codex exited with code %s.\n" "${codex_rc}" | cap_comment || true
fi
'"""

[reviewers.claude]
comment_mode = "stdout"
command = "beadsflow review --cli \"claude --tools '' --permission-mode dontAsk --no-session-persistence\""

[run]
max_iterations = 500
resume_in_progress = true
selection_strategy = "priority_then_oldest"
on_command_failure = "stop"
command_timeout_seconds = 7200
